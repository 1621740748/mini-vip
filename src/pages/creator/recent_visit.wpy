<style lang="less">
  .record-list {
    overflow: hidden;
    .image {
      display: block;
    }
    .page__bd {
      padding-bottom: 50px;
    }
    .tab-bar {
      display: flex;
      position: fixed;
      z-index: 500;
      bottom: 0;
      height: 50px;
      width: 100%;
      background-color: #f7f7fa;
      justify-content: center;
      align-items: center;
    }

    .item-body {
      width: 55%;
      height: 100%;
    }

    .page__hd {
      padding: 0px;
    }

    .weui-search-bar {
      border-bottom: 0px;
    }

    .secondary-field{
      color: #999;
      font-size: 13px;
    }

    .primary-field{
      font-size: 14px;
    }
  }
</style>

<template>
  <view class="creator-index">
    <view class="page record-list">
      <view class="page__hd">
        <searchbar :placeholder.sync="searchPlaceholder" @confirm.user="searchRecords"/>
      </view>
      <view class="page__bd">
        <block wx:if="{{record_list.length}}">
          <view class="weui-cells weui-cells_after-title">
            <repeat for="{{record_list}}" key="index" index="index" item="record">
              <navigator wx:if="{{record.record}}" url="/pages/record/view?object_name={{record.object.name}}&record_id={{record.record._id}}&space_id={{space_id}}"
                         class="record-container weui-cell weui-cell_access" data-item-id="{{record._id}}"
                         hover-class="weui-cell_active">
                <view class="weui-cell__hd">
                  <view class="slds-icon-standard-{{record.object.icon}} slds-icon slds-icon--small slds-m-right--x-small"/>
                </view>
                <view class="weui-cell__bd">
                  <view class="item-body-1">
                    <view class="primary-field">{{record.object.label || record.object.name}}</view>
                    <view class="secondary-field">{{record.record.name}}</view>
                  </view>
                </view>
              </navigator>
            </repeat>
          </view>
        </block>
        <block wx:else>
          <view class="weui-loadmore weui-loadmore_line">
            <view class="weui-loadmore__tips weui-loadmore__tips_in-line">暂无记录</view>
          </view>
        </block>
      </view>
    </view>
  </view>
</template>
<script>
  import wepy from 'wepy';
  import req from '@/network'
  import creatorClient from '@/utils/creator_client.js'
  import odataClient from '@/utils/odata_client.js'
  import searchbar from '../../components/searchbar';
  import _ from 'underscore';

  const PAGESIZE = 15;

  export default class recentVisit extends wepy.page {
    config = {
      navigationBarTitleText: '最近访问',
      enablePullDownRefresh: true,
    };

    components = {
      searchbar: searchbar,
    };

    async loadRecords(e, refresh) {
      wx.showNavigationBarLoading();
      const userId = this.$parent.globalData.user._id;
      const skip =  this.current_skip;
      const query_options = {
        $top: PAGESIZE,
        $skip: skip,
        $select: 'record',
        $expand: 'record($select=name)',
        $orderby: 'modified desc',
        $filter: `owner eq '${userId}'`,
        $count: true
      };

      if(this.searchValue){
        if(query_options.$filter){
          query_options.$filter = query_options.$filter + ` and (contains(name,'${this.searchValue}'))`
        }else{
          query_options.$filter = `(contains(name,'${this.searchValue}'))`
        }
      }

      const result = await odataClient.query('object_recent_viewed', query_options, this.space_id);

      let record_list = [];

      let oname = '';

      _.forEach(result.value, (r)=>{
        if(r.record){
          oname = r.record['reference_to._o'];
          r.object = creatorClient.getObject(oname, this.space_id);
        }
      });
      if(refresh){
        this.record_list = result.value
      }else{
        this.record_list = this.record_list.concat(result.value);
      }

      this.current_skip = skip + result.value.length;

      if (this.current_skip === result['@odata.count']) {
        this.allow_load = false
      }
      this.$apply();
      wx.hideNavigationBarLoading();
      wx.stopPullDownRefresh();
    }

    searchRecords(searchValue, evt){
      this.record_list = [];
      this.current_skip = 0;
      this.searchValue = searchValue;
      this.loadRecords();
    }

    dataRefresh() {
//      this.record_list = [];
      this.allow_load = true;
      this.current_skip = 0;
      this.loadRecords('', true);
    }

    onReachBottom() {
      console.log('onReachBottom...')
      this.loadRecords();
    }

    onPullDownRefresh() {
      console.log('onPullDownRefresh...');
      this.dataRefresh();
    }

    async onLoad(e) {
      await this.$parent.login();
      this.space_id = this.$parent.space._id;
      this.loadRecords(e);
      this.pageInit = true;
    }

    async onShow(){
      if(this.pageInit){
        this.allow_load = true;
        this.current_skip = 0;
        this.space_id = this.$parent.space._id;
        this.loadRecords('', true);
      }
    }

    data = {
      record_list: [],
      searchPlaceholder: '',
      space_id: '',
      pageInit: false,
      current_skip: 0,
    };

    methods = {
      searchRecords(searchValue, evt) {
        this.searchRecords(searchValue, evt);
      }
    };
  }
</script>
